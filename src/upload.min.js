/*
 * Pure Javascript Upload [VERSION]
 * An adaptation of valums ajaxupload(http://valums.com/ajax-upload/)
 * [DATE]
 * Corey Hart @ http://www.codenothing.com
 */
(function(j,n,l){function i(a,c){var b=-1,e=a.length;if(e===l)for(b in a)c.call(a[b],b,a[b]);else for(;++b<e;)c.call(a[b],b,a[b]);return a}function r(a,c){var b=a.settings.success,e=a.settings.complete;if(b)b.call(a,c?a.pack:a.settings.JSON?w(a.response):a.response);e&&e.call(a,a.response)}function m(a,c){var b=a.settings.error,e=a.settings.complete;if(b)b.call(a,c||a.response);if(e)compete.call(a,c||a.response)}function w(a){a=a||"";return j.JSON&&j.JSON.parse?j.JSON.parse(a):eval("("+a+")")}function s(a,
c,b,e){var d=this;d.files=a;d.data=c;d.action=b;d.settings=e;d.read={};d.xhr=l;d.aborting=false;d.boundary="";d.response="";d.length=0;i(d.files,function(o,g){if(g.files&&g.files[0])i(g.files,function(k,f){if(f&&f.fileName){d.length++;d.readFile(f)}});else if(g.fileName){d.length++;d.readFile(g)}})}function x(a,c,b,e){var d=this;d.files=a;d.data=c;d.action=b;d.settings=e;d.length=0;d.aborting=false;d.response=[];d.pack=[];d.xhr=[];d.params();i(d.files,function(o,g){if(g.files&&g.files.length)i(g.files,
function(k,f){if(f&&f.fileName){d.length++;d.send(f)}});else if(g.fileName){d.length++;d.send(g)}})}function t(a,c,b,e){var d=this,o=0,g=function(){d.load()};d.files=a;d.data=c;d.action=b;d.settings=e;d.response="";d.blank=false;d.guid=u();d.frame=y("<iframe src='javascript:false;' name='"+d.guid+"' id='"+d.guid+"' style='display:none;'></iframe>");d.form=y("<form action='"+d.action+"' method='POST' target='"+d.guid+"' style='display:none;' enctype='multipart/form-data'></form>");i(d.files,function(k,
f){if((k=f.parentNode)&&f.value&&f.value!==""){k.insertBefore(f.cloneNode(true),f);k.removeChild(f);f.name=p.prefix+ ++o;d.form.appendChild(f)}});i(d.data,function(k,f){var q=n.createElement("input");q.setAttribute("type","hidden");q.setAttribute("name",k);q.setAttribute("value",f);d.form.appendChild(q)});d.frame.attachEvent?d.frame.attachEvent("onload",g):d.frame.addEventListener("load",g,false);d.form.submit();d.form.parentNode.removeChild(d.form)}var p={action:"upload.php",prefix:"file-"},z=Object.prototype.toString.call(j.opera)===
"[object Opera]",v,y=function(){var a=n.createElement("div"),c;return function(b){n.body||h.error("Document isn't ready yet");a.innerHTML=b;c=a.removeChild(a.firstChild);n.body.appendChild(c);return c}}(),u=function(){var a=(new Date).getTime();return function(){return"PureJavascriptUpload-"+ ++a}}();s.prototype={abort:function(){i(this.read,function(a,c){c.complete===false&&c.reader.abort.call(c.reader)})},readFile:function(a){var c=this,b=new FileReader,e=u(),d=c.read[e]={file:a,name:a.fileName,
reader:b,guid:e,complete:false,content:""};b.onload=function(o){d.complete=true;d.content=o.target.result;--c.length<1&&c.request()};b.onerror=b.onabort=function(){d.complete=true;if(c.aborting===false){c.aborting=true;c.abort();m(c,"Unable to read "+a.fileName)}};b.readAsBinaryString(a)},source:function(){var a=this,c=0,b="";a.boundary="----------------------------------------"+u();i(a.read,function(e,d){e=d.file;b+="--"+a.boundary+"\r\nContent-Disposition: form-data; name='"+p.prefix+ ++c+"'; filename='"+
e.fileName+"'\r\nContent-Type: "+e.type+"\r\n\r\n"+d.content+"\r\n"});i(a.data,function(e,d){b+="--"+a.boundary+"\r\nContent-Disposition: form-data; name="+e+"\r\n\r\n"+d+"\r\n"});b+="--"+a.boundary+"--\r\n";return b},request:function(){var a=this,c=a.source(),b=a.xhr=new XMLHttpRequest;b.open("POST",a.action,true);b.setRequestHeader("Content-Type","multipart/form-data; boundary="+a.boundary);b.setRequestHeader("Content-Length",c.length);b.onreadystatechange=function(){if(b.readyState==4){a.response=
b.responseText;b.status>=200&&b.status<301||b.status===304?r(a):m(a)}};a.abort=function(){b.abort()};b.sendAsBinary(c)}};x.prototype={abort:function(){i(this.xhr,function(a,c){c.readyState!==4&&c.abort()})},params:function(){var a=this,c=a.action.indexOf("?")!==-1;i(a.data,function(b,e){a.action+=c?"&":"?";a.action+=b+"="+e;c=true})},send:function(a){var c=this,b=new XMLHttpRequest;c.xhr.push(b);b.open("POST",c.action,true);b.setRequestHeader("Content-Type","multipart/form-data");b.setRequestHeader("X-Requested-With",
"XMLHttpRequest");b.setRequestHeader("X-File-Name",a.fileName);b.setRequestHeader("X-File-Size",a.fileSize);b.upload.onload=function(){(function e(){if(b.readyState==4){var d=b.responseText;c.response+=d;if(b.status>=200&&b.status<301||b.status===304){c.pack.push(c.settings.JSON?w(d):d);--c.length<1&&r(c,true)}else if(c.aborting===false){c.aborting=true;c.abort();m(c,d)}}else setTimeout(e,15)})()};b.upload.onabort=b.upload.onerror=function(){if(c.aborting===false){c.aborting=true;c.abort();m(c,b.responseText)}};
b.send(a)}};t.prototype={abort:function(){var a=this;if(a.frame){a.blank=true;a.frame.src="javascript:'<html></html>';";m(a,"Upload canceled")}},load:function(a){var c=this,b,e;if(c.frame.src=="javascript:'%3Chtml%3E%3C/html%3E';"||c.frame.src=="javascript:'<html></html>';")c.blank&&setTimeout(function(){c.frame&&c.frame.parentNode.removeChild(c.frame)},0);else{b=c.frame.contentDocument||j.frames[c.frame.id].document;if(!(b.readyState&&b.readyState!="complete"))if(!(b.body&&b.body.innerHTML=="false"))if(z&&
a!==true)setTimeout(function(){c.load(true)},100);else{if(b.XMLDocument)c.response=b.XMLDocument;else if(b.body){c.response=b.body.innerHTML;if(c.settings.JSON===true)if((e=b.body.firstChild)&&e.nodeName.toUpperCase()==="PRE"&&e.firstChild)c.response=e.firstChild.nodeValue}else c.response=b;r(c);c.blank=true;c.frame.src="javascript:'<html></html>';"}}}};var h=j.Upload=function(a,c,b,e){var d;if(a&&!a.length)a=[a];if(e===l&&typeof b=="object"){e=b;b=l}if(typeof c=="string"){b=c;c=l}if(typeof c=="object"&&
typeof c.success=="function"){e=c;c=l}a=a;c=c||{};b=b||p.action;e=e||{};if(!a||!a.length)d="No files could be found";else if(typeof b!="string"||!b.length)d="Invalid action";return d?m({response:"",settings:e},d):new v(a,c,b,e)};h.NativeUpload=!!("FileReader"in j&&"XMLHttpRequest"in j&&typeof(new XMLHttpRequest).sendAsBinary=="function");h.DragFiles=h.NativeUpload||!!("ondrag"in n);h.error=function(a){throw typeof a=="string"?new Error(a):a;};h.normalize=function(){v=h.NativeUpload?s:t};h.ddnormalize=
function(){v=h.NativeUpload?s:h.DragFiles?x:t};h.defaults=p;h.normalize()})(this,this.document);
